name: Kotlin Release Monitor

on:
  release:
    types: [published]

jobs:
  check-file:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout released tag
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.release.tag_name }}
          fetch-depth: 0

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Determine previous tag
        id: previous
        run: |
          PREV_TAG=$(git tag --sort=-creatordate | grep -A1 ${{ github.event.release.tag_name }} | tail -n1)
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Compare metadata file
        id: diffcheck
        run: |
          FILE1=kotlin-native/runtime/src/main/cpp/TypeInfoObjCExportAddition.hpp
          FILE2=kotlin-native/runtime/src/main/cpp/TypeInfo.h

          git diff ${{ steps.previous.outputs.prev_tag }} ${{ github.event.release.tag_name }} -- $FILE1 > diff1.txt
          git diff ${{ steps.previous.outputs.prev_tag }} ${{ github.event.release.tag_name }} -- $FILE2 > diff2.txt

          if [ -s diff1.txt ]; then
            echo "file1_changed=true" >> $GITHUB_OUTPUT
          else
            echo "file1_changed=false" >> $GITHUB_OUTPUT
          fi

          if [ -s diff2.txt ]; then
            echo "file2_changed=true" >> $GITHUB_OUTPUT
          else
            echo "file2_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification
        run: |
          RELEASE=${{ github.event.release.tag_name }}
          PREV=${{ steps.previous.outputs.prev_tag }}
          F1=${{ steps.diffcheck.outputs.file1_changed }}
          F2=${{ steps.diffcheck.outputs.file2_changed }}

          MESSAGE="üì¶ Kotlin release $RELEASE published (compared to $PREV).\n\n"

          if [ "$F1" = "true" ]; then
            MESSAGE+="‚ö†Ô∏è TypeInfoObjCExportAddition.hpp changed.\n"
          else
            MESSAGE+="‚úÖ TypeInfoObjCExportAddition.hpp unchanged.\n"
          fi

          if [ "$F2" = "true" ]; then
            MESSAGE+="‚ö†Ô∏è TypeInfo.h changed.\n"
          else
            MESSAGE+="‚úÖ TypeInfo.h unchanged.\n"
          fi

          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
