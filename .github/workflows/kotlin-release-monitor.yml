name: Kotlin Release Poller

on:
  schedule:
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest

    steps:
      #- name: Checkout repo
      #  uses: actions/checkout@v4
      #  with:
      #    fetch-depth: 0

      - name: Fetch latest Kotlin release (GitHub API)
        id: api
        run: |
          RESPONSE=$(curl -s https://api.github.com/repos/JetBrains/kotlin/releases/latest)
          TAG=$(echo "$RESPONSE" | jq -r .tag_name)

          echo "latest=$TAG" >> $GITHUB_OUTPUT

      - name: Read last seen release
        id: last
        # LAST=$(cat .github/last_kotlin_release.txt)
        run: |
          LAST=v2.3.0
          echo "last=$LAST" >> $GITHUB_OUTPUT

      - name: Determine if new release
        id: changed
        run: |
          if [ "${{ steps.api.outputs.latest }}" != "${{ steps.last.outputs.last }}" ]; then
            echo "new=true" >> $GITHUB_OUTPUT
          else
            echo "new=false" >> $GITHUB_OUTPUT
          fi

      - name: Check metadata differs between releases
        id: diffs
        if: steps.changed.outputs.new == 'true'
        run: |
          PREV=${{ steps.last.outputs.last }}
          CUR=${{ steps.api.outputs.latest }}
          
          FILE1=kotlin-native/runtime/src/main/cpp/TypeInfoObjCExportAddition.hpp
          FILE2=kotlin-native/runtime/src/main/cpp/TypeInfo.h

          curl -s -H "Accept: application/vnd.github.patch" "https://api.github.com/repos/JetBrains/kotlin/compare/$PREV...$CUR" -o release.patch

          if [ ! -s release.patch ]; then
            echo "::error::Failed to get the patch. Trying again."
            PATCH=$(curl -s -H "Accept: application/vnd.github.patch" "https://api.github.com/repos/JetBrains/kotlin/compare/$PREV...$CUR")
            echo $PATCH > release.patch

            if [ ! -s release.patch ]; then
              echo "::error::Failed to get the patch again." && exit 42
            fi
          else
            echo "::error::Successfully retrieved the patch."
          fi

          grep "$FILE1" release.patch > diff1.txt
          echo "::error::diff1 made."
          grep "$FILE2" release.patch > diff2.txt
          echo "::error::diff2 made."
          
          if [ -s diff1.txt ]; then
            echo "file1_changed=true" >> $GITHUB_OUTPUT
            echo "::error::found change 1."
          else
            echo "file1_changed=false" >> $GITHUB_OUTPUT
            echo "::error::found no change 1."
          fi

          if [ -s diff2.txt ]; then
            echo "file2_changed=true" >> $GITHUB_OUTPUT
            echo "::error::found change 2."
          else
            echo "file2_changed=false" >> $GITHUB_OUTPUT
            echo "::error::found no change 2."
          fi
          echo "::error::ending..."
          
      - name: Send Slack notification
        run: |
          RELEASE=${{ steps.api.outputs.latest }}
          PREV=${{ steps.last.outputs.last }}
          NEW=${{ steps.changed.outputs.new }}

          if [ "$NEW" = "true" ]; then
            F1=${{ steps.diffs.outputs.file1_changed }}
            F2=${{ steps.diffs.outputs.file2_changed }}
  
            MESSAGE="ðŸ“¦ Kotlin release detected: $RELEASE (previous $PREV).\n\n"

            if [ "$F1" = "true" ]; then
              MESSAGE+="âš ï¸ TypeInfoObjCExportAddition.hpp changed.\n"
            else
              MESSAGE+="âœ… TypeInfoObjCExportAddition.hpp unchanged.\n"
            fi
  
            if [ "$F2" = "true" ]; then
              MESSAGE+="âš ï¸ TypeInfo.h changed.\n"
            else
              MESSAGE+="âœ… TypeInfo.h unchanged.\n"
            fi

          else
            MESSAGE="ðŸ“¦ Kotlin release checked: $PREV (no new release)."
          fi

          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Update last seen release
        if: steps.changed.outputs.new == 'true'
        run: |
          echo "${{ steps.api.outputs.latest }}" > .github/last_kotlin_release.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .github/last_kotlin_release.txt
          git commit -m "Update last seen Kotlin release"
          git push
