name: Kotlin Release Poller

on:
  schedule:
    - cron: "20 12 * * *"
  workflow_dispatch:

jobs:
  poll:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch latest Kotlin release (GitHub API)
        id: api
        run: |
          RESPONSE=$(curl -s https://api.github.com/repos/JetBrains/kotlin/releases/latest)
          TAG=$(echo "$RESPONSE" | jq -r .tag_name)

          echo "latest=$TAG" >> $GITHUB_OUTPUT

      - name: Read last seen release
        id: last
        run: |
          if [ -f .github/last_kotlin_release.txt ]; then
            LAST=$(cat .github/last_kotlin_release.txt)
          else
            LAST="v0.0.0"
          fi
          echo "last=$LAST" >> $GITHUB_OUTPUT

      - name: Determine if new release
        id: changed
        run: |
          if [ "${{ steps.api.outputs.latest }}" != "${{ steps.last.outputs.last }}" ]; then
            echo "new=true" >> $GITHUB_OUTPUT
          else
            echo "new=false" >> $GITHUB_OUTPUT
          fi

      - name: Check metadata differs between releases
        id: diffs
        if: steps.changed.outputs.new == 'true'
        run: |
          PREV=${{ steps.last.outputs.last }}
          CUR=${{ steps.api.outputs.latest }}
          
          FILE1=kotlin-native/runtime/src/main/cpp/TypeInfoObjCExportAddition.hpp
          FILE2=kotlin-native/runtime/src/main/cpp/TypeInfo.h

          git diff "$PREV" "$CUR" -- $FILE1 > diff1.txt
          git diff "$PREV" "$CUR" -- $FILE2 > diff2.txt

          if [ -s diff1.txt ]; then
            echo "file1_changed=true" >> $GITHUB_OUTPUT
          else
            echo "file1_changed=false" >> $GITHUB_OUTPUT
          fi

          if [ -s diff2.txt ]; then
            echo "file2_changed=true" >> $GITHUB_OUTPUT
          else
            echo "file2_changed=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Send Slack notification
        run: |
         RELEASE=${{ steps.api.outputs.latest }}
          PREV=${{ steps.last.outputs.last }}
          NEW=${{ steps.changed.outputs.new }}

          if [ "$NEW" = "true" ]; then
            F1=${{ steps.diffs.outputs.file1_changed }}
            F2=${{ steps.diffs.outputs.file2_changed }}
  
            MESSAGE="ðŸ“¦ Kotlin release detected: $RELEASE (previous $PREV).\n\n"

            if [ "$F1" = "true" ]; then
              MESSAGE+="âš ï¸ TypeInfoObjCExportAddition.hpp changed.\n"
            else
              MESSAGE+="âœ… TypeInfoObjCExportAddition.hpp unchanged.\n"
            fi
  
            if [ "$F2" = "true" ]; then
              MESSAGE+="âš ï¸ TypeInfo.h changed.\n"
            else
              MESSAGE+="âœ… TypeInfo.h unchanged.\n"
            fi

          else
            MESSAGE="ðŸ“¦ Kotlin release checked: $PREV (no new release)."
          fi

          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\": \"$MESSAGE\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Update last seen release
        if: steps.changed.outputs.new == 'true'
        run: |
          echo "${{ steps.api.outputs.latest }}" > .github/last_kotlin_release.txt
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add .github/last_kotlin_release.txt
          git commit -m "Update last seen Kotlin release"
          git push
